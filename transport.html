<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transport Booking | Samansiri Group</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #2980b9; --success: #27ae60; --danger: #e74c3c; --dark: #1a1a2e; }
        body { font-family: 'Poppins', sans-serif; background: #f4f7f6; margin: 0; }
        .header { background: var(--dark); color: white; padding: 60px 20px; text-align: center; }
        .container { max-width: 450px; margin: -40px auto 50px; padding: 0 20px; }
        .booking-card { background: white; padding: 35px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); border-top: 6px solid var(--primary); }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 0.9rem; }
        input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-size: 1rem; font-family: inherit; }
        input:focus { border-color: var(--primary); outline: none; }
        .btn-book { background: var(--success); color: white; border: none; padding: 15px; border-radius: 10px; width: 100%; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; }
        .btn-book:hover { background: #219150; transform: translateY(-2px); }
        .status-msg { margin-top: 20px; text-align: center; font-weight: 600; display: none; padding: 12px; border-radius: 8px; font-size: 0.9rem; border: 1px solid transparent; }
        .error { background: #fee2e2; color: #dc2626; border-color: #f87171; display: block; }
        .loading { background: #e0f2fe; color: #0369a1; border-color: #7dd3fc; display: block; }
        .available { background: #dcfce7; color: #15803d; border-color: #86efac; display: block; }
    </style>
</head>
<body>

    <div class="header">
        <h1>Book Our Fleet</h1>
        <p>Instant Availability Check</p>
    </div>

    <div class="container">
        <div class="booking-card">
            <div class="input-group">
                <label><i class="fas fa-calendar-day"></i> Select Your Date</label>
                <input type="date" id="checkDate" onchange="clearStatus()">
            </div>
            <div class="input-group">
                <label><i class="fas fa-route"></i> Destination / Route</label>
                <input type="text" id="routeDetails" placeholder="e.g. Kandy to Colombo" oninput="clearStatus()">
            </div>
            
            <div id="statusBox" class="status-msg"></div>

            <button class="btn-book" onclick="checkAndBook()">
                <i class="fab fa-whatsapp"></i> Book via WhatsApp
            </button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // Samansiri Belgium Database Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCeM9w9yDIXNVxn4astQ63a67pyjgBEHG0",
            authDomain: "samansiriholdings.firebaseapp.com",
            projectId: "samansiriholdings",
            storageBucket: "samansiriholdings.firebasestorage.app",
            messagingSenderId: "1087597234688",
            appId: "1:1087597234688:web:b80c8173d7c34d5dc6a6e5",
            databaseURL: "https://samansiriholdings-default-rtdb.europe-west1.firebasedatabase.app"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function clearStatus() {
            const statusBox = document.getElementById('statusBox');
            statusBox.style.display = 'none';
        }

        async function checkAndBook() {
            const userDate = document.getElementById('checkDate').value;
            const userRoute = document.getElementById('routeDetails').value;
            const statusBox = document.getElementById('statusBox');

            if (!userDate || !userRoute) {
                alert("Please select a date and enter your destination.");
                return;
            }

            // Show checking status
            statusBox.innerHTML = "<i class='fas fa-search'></i> Checking availability...";
            statusBox.className = "status-msg loading";
            statusBox.style.display = "block";

            try {
                // 1. Fetch current bookings from Firebase
                const snapshot = await db.ref('hireData').once('value');
                const data = snapshot.val();
                
                let isBooked = false;

                // 2. Loop through every single entry in the database
                if (data) {
                    Object.values(data).forEach(item => {
                        // Check both common keys used in your admin files
                        let dbDate = item.date || item.d;
                        
                        // Compare the database date with the user input
                        if (dbDate === userDate) {
                            isBooked = true;
                        }
                    });
                }

                // 3. Logic: Book or Block?
                if (isBooked) {
                    // BLOCK: Show error, do NOT open WhatsApp
                    statusBox.innerHTML = `<i class="fas fa-times-circle"></i> We are sorry. ${userDate} is already BOOKED.`;
                    statusBox.className = "status-msg error";
                } else {
                    // SUCCESS: Notify user and open WhatsApp
                    statusBox.innerHTML = `<i class="fas fa-check-circle"></i> Date Available! Redirecting...`;
                    statusBox.className = "status-msg available";

                    setTimeout(() => {
                        const phone = "94777105620";
                        const msg = `üöõ *VEHICLE BOOKING REQUEST*%0A*Date:* ${userDate}%0A*Route:* ${userRoute}%0A%0AThe website confirmed this date is available.`;
                        window.open(`https://wa.me/${phone}?text=${msg}`, '_blank');
                    }, 800);
                }

            } catch (error) {
                console.error(error);
                statusBox.innerHTML = "‚ö†Ô∏è Connection Error. Please try again.";
                statusBox.className = "status-msg error";
            }
        }
    </script>
</body>
</html>
